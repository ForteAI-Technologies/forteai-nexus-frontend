name: Frontend Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync

      - name: Create Environment File
        run: |
          echo "VITE_API_BASE_URL=https://nexus-backend.forteai.in/api" > .env.production
          cat .env.production

      - name: Build Production Bundle
        run: |
          rm -rf node_modules dist node_modules/.vite
          npm install --legacy-peer-deps
          npm run build
          ls -la dist/

      - name: Setup SSH Key for Bastion
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/cicd_key << 'EOF'
          -----BEGIN OPENSSH PRIVATE KEY-----
          b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
          QyNTUxOQAAACDT4MGu3x3l3HUTX7mYBFuQI32OR8VFw65zGj68QlCWoQAAAJjUTC5u1Ewu
          bgAAAAtzc2gtZWQyNTUxOQAAACDT4MGu3x3l3HUTX7mYBFUQI32OR8VFw65zGj68QlCWoQ
          AAAED59OCsItR17D6d8vMxr+BtJ7u/W7/SmRKu3uh1ZiY2a9Pgwa7fHeXcdRNfuZgEVRAj
          fY5HxUXDrnMaPrxCUJahAAAAD2NpY2QtZGVwbG95bWVudAECAwQFBg==
          -----END OPENSSH PRIVATE KEY-----
          EOF
          chmod 600 ~/.ssh/cicd_key
          ssh-keyscan 13.204.190.46 >> ~/.ssh/known_hosts 2>/dev/null

      - name: Prepare Bastion Directory
        run: |
          ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no ec2-user@13.204.190.46 "mkdir -p /tmp/frontend-deploy && rm -rf /tmp/frontend-deploy/*"

      - name: Copy Build to Bastion
        run: |
          rsync -avz -e 'ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no' dist/ ec2-user@13.204.190.46:/tmp/frontend-deploy/

      - name: Backup Current Frontend
        run: |
          ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no ec2-user@13.204.190.46 "
            ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no ec2-user@10.0.143.197 '
              if [ -d /usr/share/nginx/html ] && [ -n \"\$(ls -A /usr/share/nginx/html 2>/dev/null)\" ]; then
                BACKUP_DIR=\"/home/ec2-user/frontend-backups/backup-\$(date +%Y%m%d_%H%M%S)\"
                mkdir -p \"\$BACKUP_DIR\"
                sudo cp -r /usr/share/nginx/html/* \"\$BACKUP_DIR/\" 2>/dev/null || true
                cd /home/ec2-user/frontend-backups && ls -t | tail -n +6 | xargs -r sudo rm -rf
              fi
            '
          "

      - name: Deploy to Frontend Server
        run: |
          ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no ec2-user@13.204.190.46 "
            ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no ec2-user@10.0.143.197 'sudo rm -rf /usr/share/nginx/html/*'
            
            rsync -avz -e 'ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no' /tmp/frontend-deploy/ ec2-user@10.0.143.197:/tmp/frontend-new/
            
            ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no ec2-user@10.0.143.197 '
              sudo cp -r /tmp/frontend-new/* /usr/share/nginx/html/
              sudo chown -R nginx:nginx /usr/share/nginx/html
              sudo chmod -R 755 /usr/share/nginx/html
              rm -rf /tmp/frontend-new
            '
          "

      - name: Verify Nginx Configuration
        run: |
          ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no ec2-user@13.204.190.46 "
            ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no ec2-user@10.0.143.197 '
              sudo nginx -t
              NGINX_ROOT=\$(grep -r \"root\" /etc/nginx/conf.d/frontend.conf | awk \"{print \\\$2}\" | tr -d \";\")
              if [ \"\$NGINX_ROOT\" = \"/usr/share/nginx/html\" ]; then
                echo \"Nginx path correct\"
              else
                echo \"Warning: Nginx path is \$NGINX_ROOT\"
              fi
            '
          "

      - name: Restart Nginx
        run: |
          ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no ec2-user@13.204.190.46 "
            ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no ec2-user@10.0.143.197 '
              sudo systemctl restart nginx
              sleep 3
              if sudo systemctl is-active --quiet nginx; then
                echo \"Nginx running successfully\"
              else
                echo \"Nginx failed to start\"
                exit 1
              fi
            '
          "

      - name: Verify Deployment
        run: |
          ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no ec2-user@13.204.190.46 "
            ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no ec2-user@10.0.143.197 '
              if [ -f /usr/share/nginx/html/index.html ]; then
                echo \"index.html exists\"
                FILE_DATE=\$(stat -c %y /usr/share/nginx/html/index.html | cut -d\".\" -f1)
                echo \"Last modified: \$FILE_DATE\"
              else
                echo \"index.html NOT FOUND\"
                exit 1
              fi
              
              ASSET_COUNT=\$(find /usr/share/nginx/html/assets -type f 2>/dev/null | wc -l)
              echo \"Assets: \$ASSET_COUNT files\"
              
              HTTP_CODE=\$(curl -s -o /dev/null -w \"%{http_code}\" http://localhost/)
              if [ \"\$HTTP_CODE\" = \"200\" ]; then
                echo \"Local HTTP: \$HTTP_CODE\"
              else
                echo \"Local HTTP failed: \$HTTP_CODE\"
                exit 1
              fi
              
              if grep -r \"nexus-backend.forteai.in\" /usr/share/nginx/html/assets/*.js >/dev/null 2>&1; then
                echo \"Backend URL configured\"
              else
                echo \"Warning: Backend URL not found\"
              fi
            '
          "

      - name: Deployment Summary
        if: always()
        run: |
          echo "Frontend deployment completed"
          echo "URL: https://nexus-poc.forteai.in"
          echo "Backend: https://nexus-backend.forteai.in/api"
          echo "Deploy path: /usr/share/nginx/html"
