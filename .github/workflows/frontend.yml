name: Frontend Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync

      - name: Create Environment File
        run: |
          echo "VITE_API_BASE_URL=https://nexus-backend.forteai.in/api" > .env.production
          cat .env.production

      - name: Build Production Bundle
        run: |
          rm -rf node_modules dist node_modules/.vite
          npm install --legacy-peer-deps
          npm run build
          ls -la dist/

      - name: Setup SSH Key for Bastion
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/cicd_key << 'SSHKEY'
          -----BEGIN OPENSSH PRIVATE KEY-----
          b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
          QyNTUxOQAAACDT4MGu3x3l3HUTX7mYBFUQI32OR8VFw65zGj68QlCWoQAAAJjUTC5u1Ewu
          bgAAAAtzc2gtZWQyNTUxOQAAACDT4MGu3x3l3HUTX7mYBFUqI32OR8VFw65zGj68QlCWoQ
          AAAED59OCsItR17D6d8vMxr+BtJ7u/W7/SmRKu3uh1ZiY2a9Pgwa7fHeXcdRNfuZgEVRAj
          fY5HxUXDrnMaPrxCUJahAAAAD2NpY2QtZGVwbG95bWVudAECAwQFBg==
          -----END OPENSSH PRIVATE KEY-----
          SSHKEY
          chmod 600 ~/.ssh/cicd_key
          ssh-keyscan 13.204.190.46 >> ~/.ssh/known_hosts 2>/dev/null

      - name: Prepare Bastion Directory
        run: |
          ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no ec2-user@13.204.190.46 "mkdir -p /tmp/frontend-deploy && rm -rf /tmp/frontend-deploy/*"

      - name: Copy Build to Bastion
        run: |
          rsync -avz -e 'ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no' dist/ ec2-user@13.204.190.46:/tmp/frontend-deploy/

      - name: Backup Current Frontend
        run: |
          ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no ec2-user@13.204.190.46 "
            ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no ec2-user@10.0.143.197 '
              if [ -d /usr/share/nginx/html ] && [ -n \"\$(ls -A /usr/share/nginx/html 2>/dev/null)\" ]; then
                BACKUP_DIR=\"/home/ec2-user/frontend-backups/backup-\$(date +%Y%m%d_%H%M%S)\"
                mkdir -p \"\$BACKUP_DIR\"
                sudo cp -r /usr/share/nginx/html/* \"\$BACKUP_DIR/\" 2>/dev/null || true
                cd /home/ec2-user/frontend-backups && ls -t | tail -n +6 | xargs -r sudo rm -rf
              fi
            '
          "

      - name: Deploy to Frontend Server
        run: |
          ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no ec2-user@13.204.190.46 "
            ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no ec2-user@10.0.143.197 'sudo rm -rf /usr/share/nginx/html/*'
            
            rsync -avz -e 'ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no' /tmp/frontend-deploy/ ec2-user@10.0.143.197:/tmp/frontend-new/
            
            ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no ec2-user@10.0.143.197 '
              sudo cp -r /tmp/frontend-new/* /usr/share/nginx/html/
              sudo chown -R nginx:nginx /usr/share/nginx/html
              sudo chmod -R 755 /usr/share/nginx/html
              rm -rf /tmp/frontend-new
            '
          "

      - name: Verify Nginx Configuration
        run: |
          ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no ec2-user@13.204.190.46 "
            ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no ec2-user@10.0.143.197 'sudo nginx -t'
          "

      - name: Restart Nginx
        run: |
          ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no ec2-user@13.204.190.46 "
            ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no ec2-user@10.0.143.197 '
              sudo systemctl restart nginx
              sleep 3
              sudo systemctl is-active nginx
            '
          "

      - name: Verify Deployment
        run: |
          ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no ec2-user@13.204.190.46 "
            ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no ec2-user@10.0.143.197 '
              ls -la /usr/share/nginx/html/index.html
              ls -la /usr/share/nginx/html/sample_import.csv
            '
          "

      - name: Deployment Summary
        if: always()
        run: |
          echo "Deployment completed"
          echo "URL: https://nexus-poc.forteai.in"
