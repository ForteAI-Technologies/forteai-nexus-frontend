name: Frontend Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync

      - name: Create Environment File
        run: |
          echo "VITE_API_BASE_URL=${{ vars.BACKEND_API_URL }}" > .env.production
          cat .env.production

      - name: Build Production Bundle
        run: |
          rm -rf node_modules dist node_modules/.vite
          npm install --legacy-peer-deps
          npm run build
          ls -la dist/

      - name: Setup SSH Key for Bastion
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.BASTION_SSH_KEY }}" > ~/.ssh/cicd_key
          chmod 600 ~/.ssh/cicd_key
          ssh-keyscan ${{ vars.BASTION_IP }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Prepare Bastion Directory
        run: |
          ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no ec2-user@${{ vars.BASTION_IP }} "mkdir -p /tmp/frontend-deploy && rm -rf /tmp/frontend-deploy/*"

      - name: Copy Build to Bastion
        run: |
          rsync -avz -e 'ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no' dist/ ec2-user@${{ vars.BASTION_IP }}:/tmp/frontend-deploy/

      - name: Backup Current Frontend
        run: |
          ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no ec2-user@${{ vars.BASTION_IP }} "
            ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no ec2-user@${{ vars.FRONTEND_SERVER_IP }} '
              if [ -d /usr/share/nginx/html ] && [ -n \"\$(ls -A /usr/share/nginx/html 2>/dev/null)\" ]; then
                BACKUP_DIR=\"/home/ec2-user/frontend-backups/backup-\$(date +%Y%m%d_%H%M%S)\"
                mkdir -p \"\$BACKUP_DIR\"
                sudo cp -r /usr/share/nginx/html/* \"\$BACKUP_DIR/\" 2>/dev/null || true
                cd /home/ec2-user/frontend-backups && ls -t | tail -n +6 | xargs -r sudo rm -rf
              fi
            '
          "

      - name: Deploy to Frontend Server
        run: |
          ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no ec2-user@${{ vars.BASTION_IP }} "
            ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no ec2-user@${{ vars.FRONTEND_SERVER_IP }} 'sudo rm -rf /usr/share/nginx/html/*'
            
            rsync -avz -e 'ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no' /tmp/frontend-deploy/ ec2-user@${{ vars.FRONTEND_SERVER_IP }}:/tmp/frontend-new/
            
            ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no ec2-user@${{ vars.FRONTEND_SERVER_IP }} '
              sudo cp -r /tmp/frontend-new/* /usr/share/nginx/html/
              sudo chown -R nginx:nginx /usr/share/nginx/html
              sudo chmod -R 755 /usr/share/nginx/html
              rm -rf /tmp/frontend-new
            '
          "

      - name: Verify Nginx Configuration
        run: |
          ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no ec2-user@${{ vars.BASTION_IP }} "
            ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no ec2-user@${{ vars.FRONTEND_SERVER_IP }} '
              sudo nginx -t
              NGINX_ROOT=\$(grep -r \"root\" /etc/nginx/conf.d/frontend.conf | awk \"{print \\\$2}\" | tr -d \";\")
              if [ \"\$NGINX_ROOT\" = \"/usr/share/nginx/html\" ]; then
                echo \"âœ… Nginx path correct\"
              else
                echo \"âš ï¸ Warning: Nginx path is \$NGINX_ROOT\"
              fi
            '
          "

      - name: Restart Nginx
        run: |
          ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no ec2-user@${{ vars.BASTION_IP }} "
            ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no ec2-user@${{ vars.FRONTEND_SERVER_IP }} '
              sudo systemctl restart nginx
              sleep 3
              if sudo systemctl is-active --quiet nginx; then
                echo \"âœ… Nginx running successfully\"
              else
                echo \"âŒ Nginx failed to start\"
                exit 1
              fi
            '
          "

      - name: Verify Deployment
        run: |
          ssh -i ~/.ssh/cicd_key -o StrictHostKeyChecking=no ec2-user@${{ vars.BASTION_IP }} "
            ssh -i ~/.ssh/frontend_deploy_key -o StrictHostKeyChecking=no ec2-user@${{ vars.FRONTEND_SERVER_IP }} '
              if [ -f /usr/share/nginx/html/index.html ]; then
                echo \"âœ… index.html exists\"
                FILE_DATE=\$(stat -c %y /usr/share/nginx/html/index.html | cut -d\".\" -f1)
                echo \"ğŸ“… Last modified: \$FILE_DATE\"
              else
                echo \"âŒ index.html NOT FOUND\"
                exit 1
              fi
              
              ASSET_COUNT=\$(find /usr/share/nginx/html/assets -type f 2>/dev/null | wc -l)
              echo \"ğŸ“¦ Assets: \$ASSET_COUNT files\"
              
              HTTP_CODE=\$(curl -s -o /dev/null -w \"%{http_code}\" http://localhost/)
              if [ \"\$HTTP_CODE\" = \"200\" ]; then
                echo \"âœ… Local HTTP: \$HTTP_CODE\"
              else
                echo \"âŒ Local HTTP failed: \$HTTP_CODE\"
                exit 1
              fi
              
              if grep -r \"nexus-backend.forteai.in\" /usr/share/nginx/html/assets/*.js >/dev/null 2>&1; then
                echo \"âœ… Backend URL configured\"
              else
                echo \"âš ï¸ Warning: Backend URL not found\"
              fi
            '
          "

      - name: Deployment Summary
        if: always()
        run: |
          echo "=============================================="
          echo "ğŸ‰ Frontend Deployment Completed"
          echo "=============================================="
          echo "ğŸ“ Frontend URL: ${{ vars.FRONTEND_DOMAIN }}"
          echo "ğŸ”— Backend API: ${{ vars.BACKEND_API_URL }}"
          echo "ğŸ“‚ Deploy path: /usr/share/nginx/html"
          echo "ğŸ–¥ï¸ Server IP: ${{ vars.FRONTEND_SERVER_IP }}"
          echo "ğŸš€ Status: ${{ job.status }}"
          echo "=============================================="
