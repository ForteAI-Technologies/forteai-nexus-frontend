name: Frontend Deployment Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout code
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # 3ï¸âƒ£ Setup Environment
      - name: Setup Environment
        run: |
          echo "ğŸ” Creating .env.production..."
          echo "VITE_API_BASE_URL=https://nexus-backend.forteai.in/api" > .env.production
          echo "âœ… Created .env.production"
          cat .env.production

       # 4ï¸âƒ£ Install dependencies and build
      - name: Install Dependencies & Build
        working-directory: frontend/forteai-nexus-frontend
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          rm -rf node_modules dist node_modules/.vite
          npm install --legacy-peer-deps
          
          echo "ğŸ—ï¸ Building production bundle..."
          npm run build
          
          echo "âœ… Build completed"

      # 5ï¸âƒ£ Verify build
      - name: Verify Build Output
        working-directory: frontend/forteai-nexus-frontend
        run: |
          echo "ğŸ“‚ Build directory contents:"
          ls -la dist
      # 6ï¸âƒ£ Install sshpass
      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

        # 7ï¸âƒ£ Deploy to EC2 via Bastion
      - name: Deploy to EC2 via Bastion
        working-directory: frontend/forteai-nexus-frontend
        run: |
          echo "ğŸ“¦ Creating deployment tarball..."
          tar -czf deploy.tar.gz dist
          
          echo "ğŸ“¤ Copying tarball to Bastion..."
          sshpass -p 'forteai@123' scp -o StrictHostKeyChecking=no deploy.tar.gz ec2-user@13.204.190.46:/tmp/
          
          echo "ğŸš€ Deploying to Frontend Server..."
          sshpass -p 'forteai@123' ssh -o StrictHostKeyChecking=no ec2-user@13.204.190.46 "
            # Copy to frontend server
            sshpass -p 'forteai@1234' scp -o StrictHostKeyChecking=no /tmp/deploy.tar.gz ec2-user@10.0.143.197:/tmp/
            
            # Extract and deploy
            sshpass -p 'forteai@1234' ssh -o StrictHostKeyChecking=no ec2-user@10.0.143.197 '
              echo \"ğŸ§¹ Preparing deployment directory...\"
              sudo mkdir -p /home/ec2-user/frontend/forteai-nexus-frontend
              sudo chown -R ec2-user:ec2-user /home/ec2-user/frontend
              
              echo \"ğŸ“¦ Extracting files...\"
              cd /home/ec2-user/frontend/forteai-nexus-frontend
              tar -xzf /tmp/deploy.tar.gz
              rm -f /tmp/deploy.tar.gz
              
              echo \"âœ… Files extracted successfully\"
              ls -la dist/
            '
          "

      # 8ï¸âƒ£ Deploy build to Nginx directory
      - name: Deploy to Nginx Directory
        run: |
          echo "ğŸ“‚ Deploying to Nginx..."
          sshpass -p 'forteai@123' ssh -o StrictHostKeyChecking=no ec2-user@13.204.190.46 "
            sshpass -p 'forteai@1234' ssh -o StrictHostKeyChecking=no ec2-user@10.0.143.197 '
              echo \"ğŸ§¹ Cleaning Nginx directory...\"
              sudo rm -rf /usr/share/nginx/html/*
              
              echo \"ğŸ“‹ Copying build files...\"
              sudo cp -r /home/ec2-user/frontend/forteai-nexus-frontend/dist/* /usr/share/nginx/html/
              
              echo \"ğŸ” Setting permissions...\"
              sudo chown -R nginx:nginx /usr/share/nginx/html
              sudo chmod -R 755 /usr/share/nginx/html
              
              echo \"âœ… Frontend deployed to Nginx\"
            '
          "

      # 9ï¸âƒ£ Restart Nginx
      - name: Restart Nginx
        run: |
          echo "ğŸ”„ Restarting Nginx..."
          sshpass -p 'forteai@123' ssh -o StrictHostKeyChecking=no ec2-user@13.204.190.46 "
            sshpass -p 'forteai@1234' ssh -o StrictHostKeyChecking=no ec2-user@10.0.143.197 '
              sudo systemctl restart nginx
              sudo systemctl status nginx --no-pager
              echo \"âœ… Nginx restarted successfully!\"
            '
          "

      # ğŸ”Ÿ Verify Deployment
      - name: Verify Deployment
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸ”— Frontend URL: https://nexus-poc.forteai.in"
